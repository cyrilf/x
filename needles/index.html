<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>Needles</title>
  <style type="text/css">
  </style>
</head>
<body>
  <div id="canvasContainer"></div>
  <script type="text/javascript">
    var CANVAS_WIDTH  = 700;
    var CANVAS_HEIGHT = 700;
    var CANVAS_BACKGROUND = '#1CADC4';

    var BALL_COLOR = '#FBFD13';
    var BALL_SIZE  = 7; // In px

    var NEEDLES_X     = 15;
    var NEEDLES_Y     = 15;
    var NEEDLE_LENGTH = 18; // In px
    var NEEDLE_COLOR  = 'white';
    var NEEDLE_THICKNESS = 1;

    var canvas = initCanvas();
    var context = canvas.getContext('2d');

    var ball = {
      coord: {
        x: CANVAS_WIDTH / 2,
        y: CANVAS_HEIGHT / 2
      },
      color: BALL_COLOR,
      size: BALL_SIZE
    };

    var needles = [];

    registerEvents();
    var needles = initNeedles();
    draw();


    function initCanvas() {
      var canvas = document.createElement('canvas');
      canvas.setAttribute('width', CANVAS_WIDTH);
      canvas.setAttribute('height', CANVAS_HEIGHT);
      canvas.style.cursor = 'none';
      document.body.appendChild(canvas);

      return canvas;
    }

    function registerEvents() {
      canvas.addEventListener('mousemove', handleMove, false);
    }

    function initNeedles() {
      var x = 1;
      var y = 1;
      var needles = [];
      var needle = {};
      var center = {};

      var needlesCount = NEEDLES_X * NEEDLES_Y;
      var offsetX = (4/5) * CANVAS_WIDTH / NEEDLES_X;
      var offsetY = (4/5) * CANVAS_HEIGHT / NEEDLES_Y;

      for(; x < NEEDLES_X; x++) {
        y = 1;
        for(; y < NEEDLES_Y; y++) {
          if(x > (NEEDLES_X / 3) && (x < NEEDLES_X * 2 / 3) &&
             y > (NEEDLES_Y / 3) && (y < NEEDLES_Y * 2 / 3)) {
            continue;
          }
          center = {
            x: x * offsetX + ((CANVAS_WIDTH - offsetX * NEEDLES_X) / 2),
            y: y * offsetY + ((CANVAS_HEIGHT - offsetY * NEEDLES_Y) / 2),
          };

          needle = {
            center: center,
            extremities: [{
              x: center.x - NEEDLE_LENGTH,
              y: center.y - NEEDLE_LENGTH
            }, {
              x: center.x + NEEDLE_LENGTH,
              y: center.y + NEEDLE_LENGTH
            }]
          };
          needles.push(needle)
        }
      }

      return needles;
    }

    function handleMove(e) {
      var isTouchEvent = e.touches ? true : false;
      var x, y;
      if(isTouchEvent) {
        x = e.touches[0].pageX;
        y = e.touches[0].pageY;
      } else {
        if(typeof e.offsetX !== 'undefined') {
          x = e.offsetX;
          y = e.offsetY;
        }
        else if(e.layerX) {
          x = e.layerX;
          y = e.layerY;
        }
      }

      var coord = {
        x: x,
        y: y
      };

      updateCanvas(coord);
    }

    function updateCanvas(coord) {
      updateBall(coord);
      updateNeedles(coord);
      draw();
    }

    function updateBall(coord) {
      ball.coord = coord;
    }

    function updateNeedles(coord) {
      needles.forEach(function(needle) {
        updateNeedle(needle, coord);
      });
    }

    function updateNeedle(needle, ballCoord) {
      var xtFirst = 0, ytFirst = 0;
      var xtLast = 0, ytLast = 0;
      var distance = Math.sqrt(
        Math.pow(ballCoord.x - needle.center.x, 2) + Math.pow(ballCoord.y - needle.center.y, 2)
      );

      if (distance !== 0) {
        var t = NEEDLE_LENGTH / distance;
        xtFirst = (1 + t) * needle.center.x + (-t * ballCoord.x);
        ytFirst = (1 + t) * needle.center.y + (-t * ballCoord.y);
        xtLast = (1 - t) * needle.center.x + (t * ballCoord.x);
        ytLast = (1 - t) * needle.center.y + (t * ballCoord.y);
      }

      needle.extremities = [{
        x: xtFirst,
        y: ytFirst
      }, {
        x: xtLast,
        y: ytLast
      }];
    }


    function draw() {
      clear();
      drawBall();
      drawNeedles();
    }

    function drawBall() {
      context.beginPath();
      context.arc(ball.coord.x, ball.coord.y, BALL_SIZE, 0, 2 * Math.PI, false);
      context.fillStyle = BALL_COLOR;
      context.fill();
      this.context.closePath();
    }

    function drawNeedles() {
      context.strokeStyle = NEEDLE_COLOR;
      context.lineWidth   = NEEDLE_THICKNESS;
      needles.forEach(function(needle) {
        context.beginPath();
        this.context.moveTo(needle.extremities[0].x, needle.extremities[0].y);
        this.context.lineTo(needle.extremities[1].x + 1, needle.extremities[1].y + 1);
        this.context.closePath();
        this.context.stroke();
      });
    }

    function clear() {
      context.fillStyle = CANVAS_BACKGROUND;
      context.fillRect(0, 0, CANVAS_WIDTH, CANVAS_HEIGHT);
    }
  </script>
</body>
</html>